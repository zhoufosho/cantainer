<!DOCTYPE html>
<html>

<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel='stylesheet' href='https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css'></script>

<link href='https://fonts.googleapis.com/css?family=Oswald:700|PT+Mono|Open+Sans:300,700,300italic|Libre+Baskerville:400italic' rel='stylesheet' type='text/css'>
<style>

html {
  position: relative;
  height: 100%;
}
body {
  /* Margin bottom by footer height */
  margin-bottom: 60px;
}

p {
    font-family: 'Open Sans', sans-serif;
    font-weight: 300;
}

/*.table-layout {
    display:table;
    width:100%;
}
.table-layout .table-cell {
    display:table-cell;
    border:solid 1px #ccc;
}

.fixed-width-200 {
    width:200px;
}*/

.result-item {
    padding: 3px 15px 8px;
    border-top: 1px solid #ccc;
}

.result-item:hover {
    background-color: #ddd;
    cursor: hand;
}

.footer {
  position: absolute;
  bottom: 0;
  width: 100%;
  /* Set the fixed height of the footer here */
  height: 60px;
  background-color: #f5f5f5;
}

.main-view section {
    display: none;
}

.main-view section.active {
    display: block;
}

a.active {
    color: red;
}

ul.nav-links li{
    list-style: none;
    text-align: center;
}

#results {
    max-height: 75vh; /* TO DO: COME BACK TO THIS VALUE; */
    overflow-y: scroll;
    padding-bottom: 30px;
    background-color: #eee;

}


</style>

</head>

<body>


<div class="main-view container">
    <section id="monitor">
        <div class="col-md-12 table-cell fixed-width-200">
            <div class="row">
                <h2>What's in the jar?</h2>

                <div>

                    <h4 class="current-food">
                        Nothing...
                    </h4>
                </div>

                <p>Today you're in the [color]</p>
            </div>

        </div>
    </section>

    <section id="update" class="active">
        <div class="row">
            <div class="col-md-6 table-cell fixed-width-200 hidden-xs hidden-xs">
                <h2>What's in the jar?</h2>

                <div>

                    <h4 class="current-food">
                        Nothing...
                    </h4>
                </div>
            </div>


            <div class="select-food col-sm-12 col-md-6 table-cell">
                <h2>Select food for jar</h2>

                <form>
                  <div class="form-group">
                    <label for="foodInput">Food Item</label>
                    <input type="text" class="form-control" id="foodInput" placeholder="Search all foods...">
                  </div>
                </form>

                <div class="row">

                    <div id="results">


                    </div>
                </div>
            </div>
        </div>
    </section>

    <section id="track">
        <h2>insert graph here</h2>
    </section>

</div>

<div class="footer">
    <div class="container">
        <ul class="nav-links row">
            <div class="col-xs-4">
                <li><a href="#monitor">Monitor</a></li>
            </div>
             <div class="col-xs-4">
                <li><a href="#update" class="active">Update Jar</a></li>
            </div>
            <div class="col-xs-4">
                <li><a href="#track">View Trends</a></li>
            </div>
        </ul>
    </div>
</div>


<script src='https://code.jquery.com/jquery-2.2.3.min.js'></script>
<script src='https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js'></script>


<script>

var currentFood;
var serverCheck;

var calConsumed = 0;
var calThreshold = 0;

var ARDUINO_SIGNAL = "arduino";
var WEB_SIGNAL = "web";


function changeMainView(el) {
    $('.nav-links .active').removeClass('active');
    $(el.target).addClass('active');

    var hash = el.target.hash;
    var newView = $('.main-view').find(hash);
    $('.main-view .active').removeClass('active');
    newView.addClass('active');

}


/* 
 * TO DO: CHANGE ALL FOOD ITEMS TO OBJECTS
 * MAKE THIS LESS JANK
 * CONERT TO CALORIES PER GRAM, SOME STANDARD UNIT
 */

function FoodItem(data, source) {

    if(source == 'api') {
        this.data = data;
        this.id = data._id;

        this.cal_per_serving = data.fields.nf_calories;
        this.cal_per_g = parseFloat(this.cal_per_serving)/parseFloat(data.fields.nf_serving_weight_grams);

        this.name = data.fields.item_name;

        this.serving_size = data.fields.nf_serving_size_qty + ' ' + data.fields.nf_serving_size_unit;    
    }

    if(source == 'server') {
        this.id = data.id;
        this.name = data.name;
        this.cal_per_g = data.cal_per_g;
        this.weight = data.weight;
    }

    FoodItem.prototype.update = function(data, fieldName){
        if (fieldName == 'id'){
            this.id = data;
        } else if (fieldName == 'cal_per_g') {
            this.cal_per_g = data;
        } else if (fieldName == 'name') {
            this.name = data;
        } else if (fieldName == 'weight') {
            this.weight = data;
        }

    };

    FoodItem.prototype.handleEvent = function(event) {
        switch (event.type) {
            case "changeFromWeb": this.changeItem();
            case "changeFromServer": this.changeWeight(this.element.value);
        }
    };

    /* TO DO - HOW DOES DISPLAY FOR CURRENT ITEM WORK */
    FoodItem.prototype.changeItem = function() {

        var foodDiv = $('.current-food');


        var weight = this.weight;
        if(weight < 1) {
            weight = 0;
            calories = 0;
        } else {
            calories = Math.round(this.weight * this.cal_per_g);
        }

        foodDiv.html('<h3>' + this.name + '</h3>' + 
                     '<p>' + this.weight + ' grams </p>' +
                     '<p>' + calories + ' calories</p>'
                    );
    };    

    FoodItem.prototype.changeWeight = function(value) {
        console.log(value);
        // special event for weight change?
    };   

}

function getSearchUrl(searchTerm) {


    var APP_ID = '0c293ca4';
    var APP_KEY = '2dde1220f124a4eb10aa1ca5ad9d99d6';

    // var URL_BASE = 'https://api.nutritionix.com/v1_1/search/' + searchTerm +'?fields=item_name%2Citem_id%2Cbrand_name%2Cnf_calories%2Cnf_total_fat&appId=' + APP_ID + '&appKey=' + APP_KEY;

    var data = {};
    data.appId = APP_ID;
    data.appKey = APP_KEY;
    data.query = searchTerm;
    data.fields = ["item_name","brand_name","nf_calories","nf_serving_size_qty","nf_serving_size_unit", "nf_serving_weight_grams"];

    data.filters = {};
    data.filters.item_type = 2;

    return data;

}

function createItemDetails(item) {
    var itemId = item.id;

    var itemDiv = document.createElement("div");
    var itemLabel = document.createElement("h3");
    itemLabel.innerHTML = item.name + ' - ' + item.serving_size;

    var itemCalories = document.createElement("p");
    itemCalories.innerHTML = "Calories: " + item.cal_per_serving;

    var itemSize = document.createElement("p");
    itemSize.innerHTML = "Serving Size: " + item.serving_size;

    var calsPerG = item.cal_per_g;

    itemDiv.setAttribute('data-calPerG', calsPerG);
    itemDiv.setAttribute('data-id', itemId);
    itemDiv.setAttribute('data-name', item.name);

    itemDiv.classList.add('result-item');
    
    itemDiv.appendChild(itemLabel);
    itemDiv.appendChild(itemCalories);
    itemDiv.appendChild(itemSize);


    return itemDiv;
}

function showResults(response){
    var items = response.hits;

    var resultsDiv = document.getElementById('results');

    for(var i=0; i<items.length; i++){
        var item = new FoodItem(items[i], 'api');

        var itemDiv = createItemDetails(item);
        resultsDiv.appendChild(itemDiv);
        itemDiv.addEventListener("click", function(evt) {

            var itemDiv = evt.target;
            if(itemDiv.tagName !== 'DIV') {
                itemDiv = itemDiv.parentNode;
            }

            var calPerG = itemDiv.getAttribute('data-calPerG');
            var id = itemDiv.getAttribute('data-id');
            var name = itemDiv.getAttribute('data-name');

            postToServer(calPerG, id, name);
        });


    }
}

function showUpdatedFoodItem(foodId, name, calPerG) {
    currentFood.update(foodId, 'id')
    currentFood.update(name, 'name');
    currentFood.update(calPerG, 'cal_per_g');
    currentFood.changeItem();
}

function postToServer(calPerG, foodId, name) {
    var public_key = '1nwWg1x2GzIlzKwLQ07z';
    var private_key = '0mYp7qx4n0i4kXq1lavk';

    $.ajax({
      type:"POST",
      url: 'https://data.sparkfun.com/input/' + public_key,
      headers: {'Phant-Private-Key': private_key},
      data: {
        id: foodId,
        name: name,
        weight: '', /* arduino is responsible for handling weight, so this is blank */
        cal_per_g: calPerG,
        sender: WEB_SIGNAL,
        cal_consumed: '',
        cal_daily_threshold: ''
      },
      success: showUpdatedFoodItem(foodId, name, calPerG)
    });  
}


function searchFoods(event) {
    var term = $('#foodInput').val();
    $('#results').empty();

    var data = getSearchUrl(term);

    $.ajax({
        type:"POST",
        url: 'https://api.nutritionix.com/v1_1/search',
        data: data,
        success: showResults
    });  
}

function syncWithServer() {
    var public_key = '1nwWg1x2GzIlzKwLQ07z';

    $.ajax({
        type:"GET",
        url: 'https://data.sparkfun.com/output/' + public_key + '.json' + '?grep[sender]=' + ARDUINO_SIGNAL,
        data: {page: 1},
        dataType: 'jsonp',

        success: function(data, textStatus, jqXHR){

            if(currentFood !== undefined){
                var latest = data[0];

                console.log(latest);

                // update weight
                currentFood.update(latest.weight, 'weight');
                currentFood.changeItem();

            }
        }
    });

}


function getInitialItem() {
    var public_key = '1nwWg1x2GzIlzKwLQ07z';

    $.ajax({
        type:"GET",
        url: 'https://data.sparkfun.com/output/' + public_key + '.json' + '?grep[sender]=' + WEB_SIGNAL,
        data: {page: 1},
        dataType: 'jsonp',

        success: function(data, textStatus, jqXHR){
            if(data !== undefined){
                var latest = data[0];

                console.log(latest);
                
                currentFood = new FoodItem(latest, 'server');
                currentFood.changeItem();            

                console.log('updated: ');
                console.log(currentFood);
            }
        }
    });

}

$(document).ready(function() {
    getInitialItem();

    /* currently commented out in order to save api requests */
    searchFoods();
    // $('#foodInput').on('keyup', searchFoods);
    $('.nav-links a').on('click', changeMainView);


    serverCheck = window.setInterval(syncWithServer, 2000);

});




</script>

</body>
</html>